name: Publish widget

# 1. Sự kiện kích hoạt workflow (ví dụ: khi push code vào nhánh main)
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # BƯỚC QUAN TRỌNG: Ghi đè file config của User bằng Config chuẩn của Platform
      - name: Override Vite Config
        run: |
          cat <<EOF > vite.config.ts
          import { defineConfig } from "vite";
          import react from "@vitejs/plugin-react";
          import { viteSingleFile } from "vite-plugin-singlefile";
          import { viteStaticCopy } from "vite-plugin-static-copy";

          // Plugin chặn ảnh của bạn
          function forbidImagesPlugin() {
            return {
              name: "forbid-images",
              enforce: "pre",
              resolveId(source) {
                if (/\.(png|jpe?g)$/i.test(source)) {
                  throw new Error("❌ Image files are not allowed");
                }
                return null;
              },
            };
          }

          export default defineConfig({
            publicDir: false,
            plugins: [
              react(),
              viteSingleFile(),
              forbidImagesPlugin(),
              viteStaticCopy({
                targets: [{ src: "src/config/widget-config.json", dest: "." }],
              }),
            ],
          });
          EOF

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build